syntax = "proto3";

package confidence.flags.resolver.v1;

import "google/api/resource.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

import "confidence/api/annotations.proto";
import "confidence/flags/types/v1/types.proto";
import "confidence/flags/resolver/v1/types.proto";
import "confidence/flags/resolver/v1/api.proto";

option java_package = "com.spotify.confidence.flags.resolver.v1";
option java_multiple_files = true;
option java_outer_classname = "WasmApiProto";


message ResolveWithStickyRequest {
  ResolveFlagsRequest resolve_request = 1;

  // if a materialization info is missing, we want tor return to the caller immediately
  bool fail_fast_on_sticky = 3;
  // if we should support sticky or completely skip the flag if they had sticky rules
  bool not_process_sticky = 4;

  // Context about the materialization required for the resolve
  repeated ReadResult materializations = 5;
}


message ResolveWithStickyResponse {
  oneof resolve_result {
    Success success = 1;
    ReadOperationsRequest read_ops_request = 3;
  }
  
  message Success {
    ResolveFlagsResponse response = 1;
    repeated VariantData materialization_updates = 3;
  }
}


message VariantReadOp {
  string unit = 1;
  string materialization = 2;
  string rule = 3;
}

message InclusionReadOp {
  string unit = 1;
  string materialization = 2;
}

message ReadOp {
  oneof op {
    VariantReadOp variant_read_op = 1;
    InclusionReadOp inclusion_read_op = 2;
  }
}

message ReadOperationsRequest {
  repeated ReadOp ops = 3;
}

message VariantData {
  string unit = 1;
  string materialization = 2;
  string rule = 3;
  string variant = 4;
}

message InclusionData {
  string unit = 1;
  string materialization = 2;
  bool is_included = 3;
}

message ReadResult {
  oneof result {
    VariantData variant_result = 1;
    InclusionData inclusion_result = 2;
  }
}

message ReadOperationsResult {
  repeated ReadResult results = 1;
}

message LogMessage {
 string message = 1;
}
